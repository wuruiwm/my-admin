stages:
  - login
  - build
  - push
  - deploy

login:
  stage: login
  script:
    - docker login $DOCKER_REGISTER_HOST -u $DOCKER_REGISTER_USERNAME -p $DOCKER_REGISTER_PASSWORD

server-build:
  stage: build
  script:
    - docker build -t $DOCKER_REGISTER_HOST/wuruiwm/my_admin_new:server -f deploy/server/Dockerfile .

server-push:
  stage: push
  script:
    - docker push $DOCKER_REGISTER_HOST/wuruiwm/my_admin_new:server

web-build:
  stage: build
  script:
    - docker build --build-arg VUE_APP_PROD_API_URL=$VUE_APP_PROD_API_URL -t $DOCKER_REGISTER_HOST/wuruiwm/my_admin_new:web -f deploy/web/Dockerfile .

web-push:
  stage: push
  script:
    - docker push $DOCKER_REGISTER_HOST/wuruiwm/my_admin_new:web

deploy:
  stage: deploy
  script:
    - sshpass -p ${K8S_MASTER_PASSWORD} ssh -p ${K8S_MASTER_PORT} -o StrictHostKeyChecking=no ${K8S_MASTER_USERNAME}@${K8S_MASTER_HOST} "kubectl rollout restart -n my deployment my-admin-new"
